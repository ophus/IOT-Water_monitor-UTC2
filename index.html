<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta http-equiv="Content-Security-Policy"
      content="upgrade-insecure-requests">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gi√°m S√°t Ch·∫•t L∆∞·ª£ng N∆∞·ªõc</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="script.js"></script>
    <style>
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        background-color: #f0f2f5;
        font-family: 'Be Vietnam Pro', sans-serif;
    }
    .container {
        flex: 1;
    }
    .card {
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);

    }
    .dashboard-header {
        background: linear-gradient(135deg, #271756, #271756);
        color: #ffffff;
        padding: 20px 0;
        text-align: center;
    }
    .control-btn {
        font-size: 1.1rem;
        padding: 12px;
        border-radius: 8px;
    }
    .sensor-value {
        font-size: 2rem;
        font-weight: bold;
    }
    .footer {
        background: #271756;
        color: white;
        margin-top: auto;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .custom-title {
      font-size: 12px; 
      font-weight: bold;
      text-transform: uppercase; 
      margin-bottom: 0;
    }
    
    .text-warning-custom {
      font-size: 12px; 
      font-weight: bold;
      text-transform: uppercase;
      color: #ffc107; 
    }
    
    .chart-container {
      position: relative;
      height: 150px; /* Gi·∫£m t·ª´ 400px xu·ªëng 250px */
      width: 100%;
    }
    
  </style>
  </head>
  <link rel="icon" type="image/png" href="Media\UTC2.png">
  <body>

    <!-- Header -->
    <header class="container-fluid py-3 mb-3"
      style="background-color:#271756 ; color: white;">
      <div class="d-flex align-items-center justify-content-between px-4 mt-n2">
        <div class="d-flex align-items-center">
          <!-- Logo -->
          <img src="Media/UTC2.png" alt="Logo" class="me-3 mt-n2"
            style="height: 55px;">
          <div class="d-flex flex-column">
            <p class="custom-title mb-1 ">TR∆Ø·ªúNG ƒê·∫†I H·ªåC GIAO TH√îNG V·∫¨N T·∫¢I</p>
            <p class="text-warning-custom">PH√ÇN HI·ªÜU T·∫†I TP. H·ªí CH√ç MINH</p>
          </div>
        </div>
        <div class="text-center">
          <p class="fw-bold mb-1 text-uppercase fs-4">H·ªá Th·ªëng Gi√°m S√°t Ch·∫•t
            L∆∞·ª£ng N∆∞·ªõc</p>
          <p class="fw-bold mb-1 text-uppercase fs-6">Theo ti√™u chu·∫©n B·ªô Y T·∫ø
            &amp; QCVN 01-1:2024/BYT</p>
        </div>
        <div style="width: 80px;"></div>

      </div>
    </header>

    <!-- Main Container -->
    <!-- Main Container -->
    <div class="container">
      <div class="row">
        <!-- C·ªôt tr√°i: Th√¥ng Tin B·ªô Y T·∫ø -->
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-header bg-info text-white">
              <strong>Th√¥ng Tin B·ªô Y T·∫ø</strong>
            </div>
            <div class="card-body">
              <p class="mb-1"><strong>pH:</strong> 6.5 - 8.5</p>
              <p class="mb-1"><strong>TDS:</strong> &lt; 500 ppm</p>
              <p class="mb-1"><strong>ƒê·ªô ƒë·ª•c:</strong> &lt; 5 NTU</p>
              <p class="mb-0"><strong>Nhi·ªát ƒë·ªô:</strong> T√πy theo m√πa</p>
              <small class="text-muted">Ngu·ªìn:
                <a
                  href="Document\Vinfil-so-sanh-cac-tieu-chuan-nuoc-sach-sinh-hoat.pdf"
                  target="_blank" rel="noopener noreferrer">QCVN
                  01-1:2024/BYT</a>
              </small>
            </div>
          </div>

          <!-- ƒêi·ªÅu Khi·ªÉn H·ªá Th·ªëng - ƒê·∫∑t d∆∞·ªõi Th√¥ng Tin B·ªô Y T·∫ø -->
          <div class="card mt-4">
            <div class="card-header bg-secondary text-white">
              <strong>ƒêi·ªÅu Khi·ªÉn H·ªá Th·ªëng</strong>
            </div>
            <div class="card-body">
              <div class="d-grid gap-3">
                //<button id="btnTestSensor"
                 // class="btn btn-success control-btn">Test C·∫£m Bi·∫øn</button>
                <button id="btnStartMeasure"
                  class="btn btn-primary control-btn">B·∫Øt ƒë·∫ßu ƒêo</button>
                <button id="btnEmergencyStop"
                  class="btn btn-danger control-btn">D·ª´ng </button>
              </div>
            </div>
          </div>
        </div>

        <!-- C·ªôt ph·∫£i: Tr·∫°ng Th√°i C·∫£m Bi·∫øn & B·∫£ng Th·ªëng K√™ -->
        <div class="col-md-6">
          <!-- Tr·∫°ng Th√°i C·∫£m Bi·∫øn -->
          <div class="card mb-4">
            <div class="card-header bg-warning text-white">
              <div
                class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                <strong>Tr·∫°ng Th√°i C·∫£m Bi·∫øn</strong>
                <span id="connectionStatus" class="badge bg-success">K·∫øt
                  n·ªëi</span>
              </div>
            </div>
            <div class="card-body">
              <table class="table text-center">
                <thead>
                  <tr>
                    <th>Nhi·ªát ƒë·ªô</th>
                    <th>pH</th>
                    <th>ƒê·ªô ƒë·ª•c</th>
                    <th>TDS</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td id="tempStatus">--</td>
                    <td id="phStatus">--</td>
                    <td id="turbidityStatus">--</td>
                    <td id="tdsStatus">--</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- B·∫£ng Th·ªëng K√™ -->
          <div class="card">
            <div class="card-header bg-dark text-white">
              <strong>B·∫£ng Th·ªëng K√™</strong>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- H√†ng 1 -->
                <div class="col-md-6">
                  <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="chart-container">
                    <canvas id="phChart"></canvas>
                  </div>
                </div>
              </div>
              <div class="row mt-3">
                <!-- H√†ng 2 -->
                <div class="col-md-6">
                  <div class="chart-container">
                    <canvas id="tdsChart"></canvas>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="chart-container">
                    <canvas id="turbidityChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card mt-4">
            <div class="card-header bg-primary text-white">
              <strong>Th√¥ng S·ªë Ch·∫•t L∆∞·ª£ng N∆∞·ªõc</strong>
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-md-3 mb-3">
                  <h5>Nhi·ªát ƒê·ªô</h5>
                  <p id="tempValue" class="sensor-value">-- ¬∞C</p>
                </div>
                <div class="col-md-3 mb-3">
                  <h5>pH</h5>
                  <p id="phValue" class="sensor-value">--</p>
                </div>
                <div class="col-md-3 mb-3">
                  <h5>ƒê·ªô ƒê·ª•c</h5>
                  <p id="turbidityValue" class="sensor-value">-- NTU</p>
                </div>
                <div class="col-md-3 mb-3">
                  <h5>TDS</h5>
                  <p id="TDSValue" class="sensor-value">-- PPM</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer mt-4 py-3 text-white w-100"
      style="background-color: #271756;">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-3 text-start">
            <p class="text-warning-custom fw-bold fs-5 mb-2">ƒê·ªÄ T√ÄI:</p>
            <p class="fs-6">Gi√°m s√°t ch·∫•t l∆∞·ª£ng n∆∞·ªõc</p>
          </div>

          <div class="col-md-3 border-start">
            <p class="text-warning-custom fw-bold fs-5 mb-2">TH·ª∞C HI·ªÜN B·ªûI:</p>
            <p class="fs-6 mb-1">L√™ Minh Ph√∫c</p>
            <p class="fs-6 mb-1">L√™ Thanh V∆∞∆°ng</p>
            <p class="fs-6 mb-1">Tr·∫ßn Ho√†ng Nghƒ©a</p>
            <p class="fs-6 mb-0">Nguy·ªÖn Huy H·∫≠u</p>
          </div>

          <div class="col-md-3 border-start">
            <p class="text-warning-custom fw-bold fs-5 mb-2">M√É S·ªê SINH
              VI√äN:</p>
            <p class="fs-6 mb-1">6351030056</p>
            <p class="fs-6 mb-1">6351030086</p>
            <p class="fs-6 mb-1">6351030047</p>
            <p class="fs-6 mb-0">6351030056</p>
          </div>

          <div class="col-md-3 border-start">
            <p class="text-warning-custom fw-bold fs-5 mb-2">GI·∫¢NG VI√äN H∆Ø·ªöNG
              D·∫™N:</p>
            <p class="fs-6 mb-1">Th.S Ng√¥ Th·ªã Thu H∆∞∆°ng</p>
            <p class="fs-6 mb-0">K.S Mai V·∫°n H·∫≠u</p>
          </div>
        </div>
      </div>
    </footer>

    <script>
   const worker_url = "https://esp32-data-receiver.phucminh9395.workers.dev";
let isMeasuring = false;

// G·ª≠i l·ªánh ƒë·∫øn Worker
async function sendCommand(command) {
    try {
        const response = await fetch(`${worker_url}/command`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: command }),
        });
        const data = await response.json();
        console.log(`üì§ L·ªánh g·ª≠i ƒëi: ${command}, Ph·∫£n h·ªìi:`, data);
        return data;
    } catch (error) {
        console.error(`‚ùå L·ªói g·ª≠i l·ªánh ${command}:`, error);
    }
}

// G·ª≠i l·ªánh "ƒêo li√™n t·ª•c"
document.getElementById("btnStartMeasure").addEventListener("click", async function () {
    const response = await sendCommand("measure");
    if (response && response.success) {
        isMeasuring = true;
        console.log("B·∫Øt ƒë·∫ßu ƒëo li√™n t·ª•c");
    }
});

// G·ª≠i l·ªánh "Test" (ƒëo m·ªôt l·∫ßn)
//document.getElementById("btnTestSensor").addEventListener("click", async function () {
   // const response = await sendCommand("test");
   // if (response && response.success) {
      //  isMeasuring = true;
        // Ch·ªâ l·∫•y d·ªØ li·ªáu m·ªôt l·∫ßn sau khi test
       // setTimeout(() => {
       //     getData();
        //    isMeasuring = false;
       // }, 2000);
       // console.log("Test c·∫£m bi·∫øn m·ªôt l·∫ßn");
  //  }
//});

// G·ª≠i l·ªánh "D·ª´ng"
document.getElementById("btnEmergencyStop").addEventListener("click", async function () {
    const response = await sendCommand("stop");
    if (response && response.success) {
        isMeasuring = false;
        console.log("ƒê√£ d·ª´ng ƒëo");
    }
});

// Bi·ªÉu ƒë·ªì c·∫£m bi·∫øn
const tempChart = createChart("tempChart", "Nhi·ªát ƒë·ªô (¬∞C)", "red", "rgba(255, 0, 0, 0.2)");
const phChart = createChart("phChart", "pH", "blue", "rgba(0, 0, 255, 0.2)");
const tdsChart = createChart("tdsChart", "TDS (ppm)", "orange", "rgba(255, 165, 0, 0.2)");
const turbidityChart = createChart("turbidityChart", "ƒê·ªô ƒë·ª•c (NTU)", "green", "rgba(0, 255, 0, 0.2)");

// H√†m t·∫°o bi·ªÉu ƒë·ªì
function createChart(canvasId, label, borderColor, bgColor) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    return new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: [{
                label: label,
                data: [],
                borderColor: borderColor,
                backgroundColor: bgColor,
                borderWidth: 2,
                tension: 0.4,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { display: true },
                y: { display: true }
            }
        }
    });
}

// L·∫•y d·ªØ li·ªáu t·ª´ Worker
async function getData() {
  try {
      const response = await fetch(`${worker_url}/get_latest_sensor_data`);
      const result = await response.json();
      
      if (result.success) {
          const data = result.data;
          console.log("üìä D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data);
          
          // Ki·ªÉm tra tr·∫°ng th√°i k·∫øt n·ªëi ESP32
          const esp32Connected = result.esp32Connected !== false;
          
          // C·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫øt n·ªëi tr√™n giao di·ªán (th√™m ph·∫ßn t·ª≠ HTML hi·ªÉn th·ªã tr·∫°ng th√°i)
          const connectionStatus = document.getElementById("connectionStatus");
          if (connectionStatus) {
              connectionStatus.innerText = esp32Connected ? "K·∫øt n·ªëi" : "M·∫•t k·∫øt n·ªëi";
              connectionStatus.style.color = esp32Connected ? "green" : "red";
          }
          
          // C·∫≠p nh·∫≠t giao di·ªán v·ªõi d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c
          updateElement("tempValue", `${data.temperature} ¬∞C`);
          updateElement("phValue", `${data.ph}`);
          updateElement("TDSValue", `${data.tds} PPM`);
          updateElement("turbidityValue", `${data.turbidity} NTU`);
          
          // N·∫øu ESP32 kh√¥ng k·∫øt n·ªëi, hi·ªÉn th·ªã "M·∫•t k·∫øt n·ªëi" cho t·∫•t c·∫£ c√°c tr·∫°ng th√°i
          if (!esp32Connected) {
              updateElement("tempStatus", "M·∫•t k·∫øt n·ªëi");
              updateElement("phStatus", "M·∫•t k·∫øt n·ªëi");
              updateElement("tdsStatus", "M·∫•t k·∫øt n·ªëi");
              updateElement("turbidityStatus", "M·∫•t k·∫øt n·ªëi");
          } else {
              // N·∫øu k·∫øt n·ªëi, hi·ªÉn th·ªã tr·∫°ng th√°i b√¨nh th∆∞·ªùng
              updateElement("tempStatus", getStatusText(data.temperature, 20, 30));
              updateElement("phStatus", getStatusText(data.ph, 6.5, 8.5));
              updateElement("tdsStatus", getStatusText(data.tds, 0, 500, true));
              updateElement("turbidityStatus", getStatusText(data.turbidity, 0, 5, true));
          }
          
          // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
          const now = new Date().toLocaleTimeString();
          updateChart(tempChart, now, data.temperature);
          updateChart(phChart, now, data.ph);
          updateChart(tdsChart, now, data.tds);
          updateChart(turbidityChart, now, data.turbidity);
      }
  } catch (error) {
      console.error("‚ùå L·ªói l·∫•y d·ªØ li·ªáu t·ª´ Worker:", error);
  }
}

// ƒê√°nh gi√° tr·∫°ng th√°i th√¥ng s·ªë
function getStatusText(value, min, max, lowerIsBetter = false) {
    if (lowerIsBetter) {
        if (value <= max * 0.6) return "T·ªët";
        if (value <= max) return "B√¨nh th∆∞·ªùng";
        return "Cao";
    } else {
        if (value < min) return "Th·∫•p";
        if (value > max) return "Cao";
        return "B√¨nh th∆∞·ªùng";
    }
}

// C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
function updateChart(chart, label, value) {
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(value);
    
    if (chart.data.labels.length > 10) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    
    chart.update();
}

// C·∫≠p nh·∫≠t ph·∫ßn t·ª≠ giao di·ªán
function updateElement(id, value) {
    const el = document.getElementById(id);
    if (el) el.innerText = value;
}

// Ki·ªÉm tra li√™n t·ª•c n·∫øu ƒëang trong ch·∫ø ƒë·ªô ƒëo
setInterval(() => {
    if (isMeasuring) {
        getData();
    }
}, 2000);

// Kh·ªüi t·∫°o - l·∫•y tr·∫°ng th√°i ƒëo
async function init() {
    await getData(); // L·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t n·∫øu c√≥
}
        </script>

  </footer>
</footer>
